#!/bin/bash

# Global Variables
BUILD_DEPS="TRUE"
NO_CACHE=""
TARGET=""

exit-with-error()
{
    echo -e "$@"
    exit 1
}

# parsing command line arguments
while [[ $# > 0 ]]; do
    key="$1"

    case $key in
        -h|--help)
            echo ""
            echo "Usage: build [options] <target>"
            echo ""
            echo "Options:"
            echo "  -nd|--no-deps    - skip building of dependencies  (default - Build dependencies)"
            echo "  -nc|--no-cache   - does not use the Docker cache  (default - Build with cache)"
            echo ""
            echo "If no target is specified then all directories are built (except custom-dockers)"
            echo "If a target is specified then directory (within custom-dockers) must exist"
            exit 1
            ;;
        -nd|--no-deps)
            BUILD_DEPS="FALSE"
            ;;
        -nc|--no-cache)
            NO_CACHE="--no-cache"
            ;;
        -*)
            exit-with-error "Unkown option $key"
            ;;
        *)
            if [ ! -z "$TARGET" ]; then
                exit-with-error "ERROR: Only one target can be specified"
            fi
            TARGET="$key"
            ;;
    esac
    shift # past argument or value
done

echo ""

docker-wrapper()
{
    # Set this variable to TRUE if you are testing changes.
    # This will stop the docker commands for debugging script.
    if [ "${debug^^}" != "TRUE" ]; then
        docker $@ || exit-with-error "ERROR: Docker build failed"
    fi
}

build-docker()
{
    local dir="$1"
    
    if [ $BUILD_DEPS == "TRUE" ] && [ ! -z $TARGET ]; then
        parent=$(grep -i ^FROM $dir/Dockerfile | awk '{print $2}')
        echo "Building docker: $parent in inherit-dockers"
        docker-wrapper build -t $parent -f ../inherit-dockers/$parent/Dockerfile $NO_CACHE ../inherit-dockers/$parent
    fi
    
    echo "Building docker: ${dir##*/}"
    docker-wrapper build -t ${dir##*/} -f $dir/Dockerfile $NO_CACHE $dir
}

if [ "$TARGET" == "" ]; then
    BUILD_DEPS="FALSE"
    directories=$(find . -name custom-dockers* -prune -or -type d)
    
    # Loop through directories and build everything
    for directory in $directories; do
        if [ -f ${directory#./}/Dockerfile ]; then
            echo "Entering directory: ${directory#./}"
            build-docker ${directory#./}
            echo ""
        fi
    done
else
    if [ ! -d "custom-dockers/$TARGET" ]; then
        exit-with-error "custom-dockers/$TARGET does not exist, aborting..."
    fi
    cd custom-dockers
    build-docker $TARGET
    cd ..
fi

echo ""
echo "Completed Successfully"
echo ""